name: PR Checks

on:
  pull_request:
    branches: [ dev ]

jobs:
  version-check:
    name: Verify Version Bump
    runs-on: ubuntu-latest
    steps:
    - name: Checkout PR
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Get current version from PR
      id: pr-version
      run: |
        NEW_VERSION=$(grep "version = " pyproject.toml | cut -d'"' -f2)
        echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
        echo "PR Version: $NEW_VERSION"

    - name: Get version from dev branch
      id: dev-version
      run: |
        git checkout origin/dev
        OLD_VERSION=$(grep "version = " pyproject.toml | cut -d'"' -f2)
        echo "old_version=$OLD_VERSION" >> $GITHUB_OUTPUT
        echo "Dev Version: $OLD_VERSION"
        git checkout -

    - name: Compare versions
      run: |
        OLD_VERSION="${{ steps.dev-version.outputs.old_version }}"
        NEW_VERSION="${{ steps.pr-version.outputs.new_version }}"
        
        echo "Comparing versions:"
        echo "  Dev branch: $OLD_VERSION"
        echo "  PR branch:  $NEW_VERSION"
        
        if [ "$OLD_VERSION" = "$NEW_VERSION" ]; then
          echo "âŒ VERSION CHECK FAILED"
          echo "Version must be updated in pyproject.toml before merging"
          echo "Current version: $OLD_VERSION"
          echo "Please increment the version (e.g., to $OLD_VERSION.1 or next minor/major version)"
          exit 1
        fi
        
        echo "âœ… Version updated from $OLD_VERSION to $NEW_VERSION"

    - name: Validate version format
      run: |
        VERSION="${{ steps.pr-version.outputs.new_version }}"
        if [[ ! $VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
          echo "âŒ Invalid version format: $VERSION"
          echo "Version must follow semantic versioning (e.g., 1.2.3)"
          exit 1
        fi
        echo "âœ… Version format is valid: $VERSION"

    - name: Check version increase
      run: |
        OLD_VERSION="${{ steps.dev-version.outputs.old_version }}"
        NEW_VERSION="${{ steps.pr-version.outputs.new_version }}"
        
        # Convert versions to comparable numbers
        OLD_MAJOR=$(echo $OLD_VERSION | cut -d. -f1)
        OLD_MINOR=$(echo $OLD_VERSION | cut -d. -f2)
        OLD_PATCH=$(echo $OLD_VERSION | cut -d. -f3)
        
        NEW_MAJOR=$(echo $NEW_VERSION | cut -d. -f1)
        NEW_MINOR=$(echo $NEW_VERSION | cut -d. -f2)
        NEW_PATCH=$(echo $NEW_VERSION | cut -d. -f3)
        
        OLD_NUMERIC=$((OLD_MAJOR * 10000 + OLD_MINOR * 100 + OLD_PATCH))
        NEW_NUMERIC=$((NEW_MAJOR * 10000 + NEW_MINOR * 100 + NEW_PATCH))
        
        if [ $NEW_NUMERIC -le $OLD_NUMERIC ]; then
          echo "âŒ Version must be higher than current version"
          echo "Current: $OLD_VERSION ($OLD_NUMERIC)"
          echo "New:     $NEW_VERSION ($NEW_NUMERIC)"
          exit 1
        fi
        
        echo "âœ… Version properly incremented"

  test:
    name: Run Tests
    runs-on: windows-latest
    needs: version-check
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        version: latest
        virtualenvs-create: true
        virtualenvs-in-project: true

    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: .venv
        key: venv-${{ runner.os }}-${{ hashFiles('**/poetry.lock') }}

    - name: Install dependencies
      run: poetry install

    - name: Run tests
      run: |
        echo "Running full test suite..."
        poetry run pytest tests/ -v --tb=short
      
    - name: Test results summary
      if: always()
      run: |
        if [ $? -eq 0 ]; then
          echo "âœ… All tests passed! Ready for merge."
        else
          echo "âŒ Tests failed! Please fix failing tests before merge."
          exit 1
        fi

  build-test:
    name: Test Build Process
    runs-on: windows-latest
    needs: [version-check, test]
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        version: latest
        virtualenvs-create: true
        virtualenvs-in-project: true

    - name: Install dependencies
      run: poetry install

    - name: Add PyInstaller
      run: poetry add --group dev pyinstaller

    - name: Test build process
      run: |
        echo "Testing executable build process..."
        poetry run python -m PyInstaller --clean bitcraft_companion.spec
        
    - name: Verify build output
      run: |
        if (Test-Path "dist\*.exe") {
          $exe = Get-ChildItem "dist\*.exe" | Select-Object -First 1
          Write-Host "âœ… Build test successful!"
          Write-Host "Generated: $($exe.Name)"
          Write-Host "Size: $([math]::Round($exe.Length/1MB, 2)) MB"
        } else {
          Write-Host "âŒ Build test failed - no executable generated"
          exit 1
        }

  pr-summary:
    name: PR Summary
    runs-on: ubuntu-latest
    needs: [version-check, test, build-test]
    if: always()
    steps:
    - name: PR Status Summary
      run: |
        echo "## PR Validation Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        VERSION_STATUS="${{ needs.version-check.result }}"
        TEST_STATUS="${{ needs.test.result }}"
        BUILD_STATUS="${{ needs.build-test.result }}"
        
        echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Version Bump | $( [ "$VERSION_STATUS" = "success" ] && echo "âœ… Passed" || echo "âŒ Failed" ) |" >> $GITHUB_STEP_SUMMARY
        echo "| Tests | $( [ "$TEST_STATUS" = "success" ] && echo "âœ… Passed" || echo "âŒ Failed" ) |" >> $GITHUB_STEP_SUMMARY
        echo "| Build Test | $( [ "$BUILD_STATUS" = "success" ] && echo "âœ… Passed" || echo "âŒ Failed" ) |" >> $GITHUB_STEP_SUMMARY
        
        if [ "$VERSION_STATUS" = "success" ] && [ "$TEST_STATUS" = "success" ] && [ "$BUILD_STATUS" = "success" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ‰ **All checks passed! This PR is ready to merge.**" >> $GITHUB_STEP_SUMMARY
        else
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âŒ **Some checks failed. Please fix issues before merging.**" >> $GITHUB_STEP_SUMMARY
        fi